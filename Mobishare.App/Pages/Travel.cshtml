@page
@model Mobishare.App.Pages.TravelModel
@{
    ViewData["NoLayoutCss"] = true;
}
@inject IConfiguration Configuration

@if (Model.Ride == null)
{
    <script>
        window.location.href = '/LandingPage';
    </script>
    <div style="text-align: center; padding: 50px;">
        <p>Nessun viaggio attivo. Reindirizzamento in corso...</p>
    </div>
    return;
}

<!-- Mappa -->
<div class="controls">
    <div id="map"></div>
    <input type="hidden" id="allCities" value="@Model.AllCitiesPerimeter" />
    <input type="hidden" id="allParkingSlots" value="@Model.AllParkingSlotsPerimeter" />
</div>


<!-- Contenuto principale -->
<main class="content">
    <!-- Informazioni bici -->
    <div class="card">
        <div class="card-content">
            <div class="bike-info">
                <div class="bike-image">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjMTZhMzRhIi8+CjxwYXRoIGQ9Ik0xMiAzNmMtMy4zIDAtNi0yLjctNi02czIuNy02IDYtNiA2IDIuNyA2IDYtMi43IDYtNiA2em0wLTEwYy0yLjIgMC00IDEuOC00IDRzMS44IDQgNCA0IDQtMS44IDQtNC0xLjgtNC00LTR6bTI0IDEwYy0zLjMgMC02LTIuNy02LTZzMi43LTYgNi02IDYgMi43IDYgNi0yLjcgNi02IDZ6bTAtMTBjLTIuMiAwLTQgMS44LTQgNHMxLjggNCA0IDQgNC0xLjggNC00LTEuOC00LTQtNHptLTEyLTEwYy0xLjEgMC0yLS45LTItMnMuOS0yIDItMiAyIC45IDIgMi0uOSAyLTIgMnptOCAxNGgtNGwtMi00aDRsNCA0eiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+"
                        alt="EcoBike Pro">
                </div>
                <div class="bike-details">
                    <h2>EcoBike Pro</h2>
                    <p>@(Model.VehicleType?.Type)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dettagli viaggio -->
    <div class="trip-details">
        <div class="card">
            <div class="card-content">
                <div class="detail-item">
                    <svg class="detail-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm4.2 14.2L11 13V7h1.5v5.2l4.5 2.7-.8 1.3z" />
                    </svg>
                    <div class="detail-content">
                        <p>Orario di Inizio</p>
                        <p>@(Model.Ride?.StartDateTime.ToString() ?? "N/A")</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-content">
                <div class="detail-item">
                    <svg class="detail-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                    </svg>
                    <div class="detail-content">
                        <p>Luogo di Partenza</p>
                        <p>@Model.StartLocationName</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cronometro -->
    <div class="card timer-card">
        <div class="card-content">
            <p class="timer-label">Tempo Trascorso</p>
            <div class="timer-display" id="timer">00:00</div>
            <div class="timer-indicator">
                <div class="pulse-dot"></div>
            </div>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="stats-grid">
        <div class="card">
            <div class="card-content stat-card">
                <div class="stat-value" id="distanceValue">2.3</div>
                <div class="stat-label">km percorsi</div>
            </div>
        </div>
        <div class="card">
            <div class="card-content stat-card">
                <div class="stat-value" id="costValue">€0.00</div>
                <div class="stat-label">costo attuale</div>
            </div>
        </div>
    </div>

    <!-- Pulsante termina viaggio -->
    <button class="end-trip-button" onclick="endTrip()">
        Termina Viaggio
    </button>

    <!-- Info aggiuntive -->
    <div class="footer-info">
        <p>Ricorda di parcheggiare in un'area consentita</p>
    </div>

    <!-- Modal per terminare il viaggio -->
    <div class="modal fade" id="endTripModal" tabindex="-1" aria-labelledby="endTripModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="endTripModalLabel">Termina Viaggio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Vuoi terminare il viaggio?</strong></p>
                    <p class="text-muted">Il timer si fermerà solo dopo la conferma. Se annulli, il viaggio continuerà.
                    </p>
                    <div class="mb-3">
                        <label for="tripName" class="form-label">Dai un nome al tuo viaggio (opzionale):</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="tripName" placeholder="Es: Viaggio al lavoro">
                            <button class="btn btn-outline-primary" type="button" id="aiSuggestBtn"
                                title="Suggerimento AI (coming soon)">
                                <svg width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                    <path
                                        d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.734 1.734 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.1z" />
                                </svg>
                            </button>
                        </div>
                        <small class="form-text text-muted">💡 Presto: suggerimenti AI basati su orario, posizione e
                            preferenze</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla e Continua</button>
                    <button type="button" class="btn btn-danger" id="confirmEndTrip">Termina Definitivamente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form nascosto per inviare i dati -->
    <form id="endTripForm" method="post" asp-page-handler="EndTrip" style="display: none;">
        <input type="hidden" id="tripNameInput" name="tripName" />
        <input type="hidden" name="rideId" value="@(Model.Ride?.Id ?? 0)" />
    </form>
</main>

<style>
    .gmnoprint {
        display: none !important;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"
    integrity="sha512-7SRCYIJtR6F8ocwW7UxW6wGKqbSyqREDbfCORCbGLatU0iugBLwyOXpzhkPyHIFdBO0K2VCu57fvP2Twgx1o2A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Script per passare dati al JavaScript -->
<script>
    // --- 1. DATI INIZIALI E VARIABILI GLOBALI ---

    // I dati del viaggio vengono passati dal server (Razor) a JavaScript
    window.rideData = {
        rideId: @(Model.Ride?.Id ?? 0),
        costPerMinute: @Model.CostPerMinute.ToString("F2", System.Globalization.CultureInfo.InvariantCulture),
        startDateTime: '@(Model.Ride?.StartDateTime.ToString("yyyy-MM-ddTHH:mm:ss.fffZ") ?? "")',
        vehicleId: @(Model.Ride?.VehicleId ?? 0),
        vehicleType: '@(Model.VehicleType?.Type ?? "")'
    };

    // Variabili che verranno usate durante il ciclo di vita della pagina
    let startTime;
    let timerInterval;
    let costUpdateInterval;
    let vehicleMarkers = {}; // Oggetto per tenere traccia dei marker sulla mappa


    // --- 2. LOGICA DI INIZIALIZZAZIONE PRINCIPALE ---

    // Questa è la funzione principale che viene eseguita quando la pagina è pronta
    document.addEventListener('DOMContentLoaded', function () {
        initializePage();       // Fa partire subito timer e costo
        connectAndWaitForMap(); // Avvia la connessione a SignalR e l'attesa della mappa
        setupButtonListeners(); // Imposta gli eventi per i bottoni del modal
    });


    // --- 3. GESTIONE DELLA MAPPA E SIGNALR (IL CUORE DELLA SOLUZIONE) ---

    /**
     * Si connette a SignalR e poi avvia un controllo a intervalli
     * per aspettare che la variabile 'map' sia creata dal file esterno site.js.
     */
    function connectAndWaitForMap() {
        const hub = new signalR.HubConnectionBuilder().withUrl("/VehicleHub").build();

        hub.start()
            .then(() => {
                console.log("Connessione a SignalR stabilita. In attesa che la mappa sia pronta...");

                const mapCheckInterval = setInterval(function () {
                    // Controlla ogni 100ms se la mappa globale (da site.js) è stata creata
                    if (typeof map !== 'undefined' && map) {
                        // Trovata! La mappa è pronta.
                        console.log("Mappa trovata! Inizializzo gli aggiornamenti in tempo reale.");
                        clearInterval(mapCheckInterval); // Interrompi il controllo, non serve più
                        setupSignalRMapListener(hub);  // Avvia la funzione che ascolta i messaggi
                    }
                }, 100); // Frequenza del controllo
            })
            .catch(err => console.error("Errore fatale nella connessione a SignalR:", err));
    }

    function setupSignalRMapListener(hub) {
        hub.on("ReceiveVehiclePositionUpdate", (vehicle) => {
            const id = vehicle.vehicleId.toString();

            // Aggiorna la posizione solo se il messaggio è per il veicolo che stiamo guidando
            if (window.rideData.vehicleId == id) {
                const newPosition = { lat: vehicle.latitude, lng: vehicle.longitude };
                map.setCenter(newPosition);
                if (vehicleMarkers[id]) {
                    // Se il marker esiste già, aggiorna solo la sua posizione
                    vehicleMarkers[id].setPosition(newPosition);
                } else {
                    // Altrimenti, crea un nuovo marker
                    const markerIcon = {
                        url: "/img/vehicle/icon/bicycle.png",
                        scaledSize: new google.maps.Size(40, 40)
                    };
                    const marker = new google.maps.Marker({
                        position: newPosition,
                        map: map, // Ora siamo sicuri che 'map' esista
                        icon: markerIcon,
                        title: `Veicolo ${id}`
                    });
                    vehicleMarkers[id] = marker; // Salva il marker per futuri aggiornamenti
                }
            }
        });
    }


    // --- 4. FUNZIONALITÀ DELLA PAGINA (Timer, Costo, Bottoni) ---

    /**
     * Inizializza il timer e il calcolo del costo all'avvio della pagina.
     */
    function initializePage() {
        if (!window.rideData || !window.rideData.startDateTime) {
            console.error('Dati del viaggio o orario di inizio mancanti.');
            return;
        }
        startTime = new Date(window.rideData.startDateTime);
        if (isNaN(startTime.getTime())) {
            console.error('Orario di inizio non valido:', window.rideData.startDateTime);
            return;
        }
        
        // Fa partire gli aggiornamenti continui
        startTimer();
        startCostUpdater();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        updateTimer(); // Esegui subito per mostrare il valore corretto
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        const elapsed = new Date() - startTime;
        if (elapsed < 0) return;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function startCostUpdater() {
        if (costUpdateInterval) clearInterval(costUpdateInterval);
        updateCost(); // Esegui subito
        costUpdateInterval = setInterval(updateCost, 1000);
    }

    function updateCost() {
        const elapsedMinutes = (new Date() - startTime) / 60000;
        if (elapsedMinutes < 0) return;

        const costPerMinute = parseFloat(window.rideData.costPerMinute);
        const fixedCostMap = { Bike: 5, Scooter: 7, EBike: 6 };
        const fixedCost = fixedCostMap[window.rideData.vehicleType] || 0;
        
        let currentCost = fixedCost;
        if (elapsedMinutes > 30) {
            currentCost += (elapsedMinutes - 30) * costPerMinute;
        }

        const costElement = document.getElementById('costValue');
        if (costElement) {
            costElement.textContent = `€${currentCost.toFixed(2)}`;
        }
    }

    /**
     * Mostra il modal di conferma per terminare il viaggio.
     */
    function endTrip() {
        const modalElement = document.getElementById('endTripModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            new bootstrap.Modal(modalElement).show();
        }
    }
    
    /**
     * Raggruppa tutti i listener per i bottoni del modal e altri elementi interattivi.
     */
    function setupButtonListeners() {
        const confirmButton = document.getElementById('confirmEndTrip');
        if (confirmButton) {
            confirmButton.addEventListener('click', function () {
                console.log('Viaggio terminato dall\'utente.');
                clearInterval(timerInterval);
                clearInterval(costUpdateInterval);
                
                document.getElementById('tripNameInput').value = document.getElementById('tripName').value;
                document.getElementById('endTripForm').submit();
            });
        }
        
        const aiSuggestBtn = document.getElementById('aiSuggestBtn');
        if (aiSuggestBtn) {
            aiSuggestBtn.addEventListener('click', function () {
                const currentTime = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const suggestions = [`Viaggio ${currentTime}`, 'Spostamento mattutino', 'Tragitto serale', 'Viaggio veloce', 'Tour in città'];
                const randomSuggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
                aiSuggestBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                aiSuggestBtn.disabled = true;
                setTimeout(() => {
                    document.getElementById('tripName').value = randomSuggestion;
                    aiSuggestBtn.innerHTML = `<svg width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.734 1.734 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.1z"/></svg>`;
                    aiSuggestBtn.disabled = false;
                }, 1500);
            });
        }
        
        const modal = document.getElementById('endTripModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function (event) {
                if (timerInterval && costUpdateInterval) {
                    console.log('Modal chiuso, il viaggio continua.');
                } else {
                    console.log('Modal chiuso dopo la conferma di fine viaggio.');
                }
            });
        }
    }

    /**
     * Questa funzione viene chiamata dal callback dell'API di Google Maps.
     * La sua implementazione reale è in site.js.
     */
    function initMaps() {
        // L'implementazione vera è in site.js
    }

</script>

<script src='@($"https://maps.googleapis.com/maps/api/js?key={Configuration["GoogleMaps:ApiKey"]}&callback=initMaps")'
    async defer></script>
<script src="~/js/site.js" type="text/javascript"></script>
<link rel="stylesheet" href="~/css/travel.css">