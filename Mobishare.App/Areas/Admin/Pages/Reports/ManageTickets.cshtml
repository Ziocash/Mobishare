@page
@model Mobishare.App.Areas.Admin.Pages.Reports.ManageTicketsModel

<h4>All Tickets</h4>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Success!</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error!</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<h3 class="mt-4">My Assigned Ticket</h3>

@{
    var myAssignedTicket = Model.AllReports.FirstOrDefault(r => r.Status == "Assigned");
}

@if (myAssignedTicket != null)
{
    <div class="card">
        <div class="card-header">
            <strong>Report ID: @myAssignedTicket.Id</strong>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="card-title">Report Description</h5>
                    <p class="card-text bg-light p-2 rounded">@myAssignedTicket.Description</p>

                    @if (!string.IsNullOrEmpty(myAssignedTicket.Image))
                    {
                        <h5>Image</h5>
                        <img src="@myAssignedTicket.Image" alt="Report Image" class="img-fluid rounded mb-3" />
                    }

                    <h5>Position</h5>
                    @{
                        var lastPos = myAssignedTicket.Vehicle?.Positions
                            .OrderByDescending(p => p.GpsReceptionTime)
                            .FirstOrDefault();
                    }
                    @if(lastPos != null)
                    {
                        <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=@lastPos.Latitude,@lastPos.Longitude" class="btn btn-outline-primary">
                            Show on Map
                        </a>
                    }
                    else
                    {
                        <p>No position data available.</p>
                    }
                </div>

                <div class="col-md-6">
                    <form method="post" asp-page-handler="CloseTicket" asp-route-id="@myAssignedTicket.Id">
                        <input type="hidden" asp-for="Input.ReportId" value="@myAssignedTicket.Id" />
                        <div class="form-group">
                            <label asp-for="Input.RepairDescription"><strong>Repair Description:</strong></label>
                            <textarea asp-for="Input.RepairDescription" class="form-control" rows="5" placeholder="Enter the details of the repair work done..."></textarea>
                            <span asp-validation-for="Input.RepairDescription" class="text-danger"></span>
                        </div>
                        @* <div class="form-group mt-3">
                            <label asp-for="Input.NewStatus"><strong>Update Status:</strong></label>
                            <select asp-for="Input.NewStatus" class="form-control">
                                <option value="Assigned" selected>Keep as Assigned</option>
                                <option value="Closed">Close Ticket</option>
                            </select>
                        </div> *@
                        <button type="submit" class="btn btn-success mt-4">Close Ticket</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <p>You do not have any ticket assigned to you.</p>
}

<h3 class="mt-5">Pending Tickets</h3>
@if (Model.AllReports == null || !Model.AllReports.Any(r => r.Status == "Pending"))
{
    <p>No pending tickets available.</p>
}
else
{
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Description</th>
                <th>Date</th>
                <th>Vehicle</th>
                <th>Image</th>
                <th>Position</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var report in Model.AllReports.Where(r => r.Status.Equals("Pending")))
            {
                <tr>
                    <td>@report.Description</td>
                    <td>@report.CreatedAt.ToString("dd/MM/yyyy")</td>
                    <td>@report.Vehicle?.Plate</td>
                    <td>
                        @if (!string.IsNullOrEmpty(report.Image))
                        {
                            <img src="@report.Image" alt="Report Image" width="100" />
                        }
                    </td>
                    <td>
                        @{
                            var lastPos = report.Vehicle?.Positions
                                .OrderByDescending(p => p.GpsReceptionTime)
                                .FirstOrDefault();
                        }
                        @if(lastPos != null)
                        {
                            <a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=@lastPos.Latitude,@lastPos.Longitude">
                                Show on Map
                            </a>
                        }
                    </td>
                    <td>
                        @if (myAssignedTicket == null)
                        {
                            <form method="post" asp-page-handler="AssignTicket" asp-route-id="@report.Id">
                                <button type="submit" class="btn btn-primary btn-sm">Assign to Me</button>
                            </form>
                        }
                        else
                        {
                            <button class="btn btn-secondary btn-sm" disabled>Unavailable</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<h3 class="mt-5">Closed Tickets</h3>
@if (Model.AllReports == null || !Model.AllReports.Any(r => r.Status == "Closed"))
{
    <p>No closed tickets found.</p>
}
else
{
    <table class="table table-striped table-bordered">
        <thead class="thead-light">
            <tr>
                <th>Report id</th>
                <th>Original Description</th>
                <th>Image</th>
                <th>Technician's Notes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var report in Model.AllReports.Where(r => r.Status == "Closed"))
            {
                <tr>
                    <td>@report.Id</td>
                    <td>@report.Description</td>
                    <td>
                        @if (!string.IsNullOrEmpty(report.Image))
                        {
                            <img src="@report.Image" alt="Report Image" width="100" />
                        }
                    </td>
                    <td>
                        @* <strong>@report.Repair?.Description</strong> *@
                    </td>
                </tr>
            }
        </tbody>
    </table>
}